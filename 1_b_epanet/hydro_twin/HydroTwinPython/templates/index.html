{% extends "base.html" %}

{% block title %}Dashboard - HydroTwin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tint text-primary"></i> HydroTwin Dashboard
        </h1>
        <p class="lead">Real-time EPANET Water Distribution Network Simulation Platform</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-network-wired fa-3x text-primary mb-3"></i>
                <h5 class="card-title">Network Files</h5>
                <p class="card-text" id="network-count">Loading...</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-play-circle fa-3x text-success mb-3"></i>
                <h5 class="card-title">Simulations</h5>
                <p class="card-text">4 Types Available</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                <h5 class="card-title">Real-time Monitoring</h5>
                <p class="card-text">Live Data</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-database fa-3x text-warning mb-3"></i>
                <h5 class="card-title">SCADA Integration</h5>
                <p class="card-text">Database Logging</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Quick Start</h5>
            </div>
            <div class="card-body">
                <p>Get started with EPANET simulations:</p>
                <ol>
                    <li>Select a network file from the available options</li>
                    <li>Choose a simulation type (Simple, Advanced, SCADA, or Comprehensive)</li>
                    <li>Configure simulation parameters</li>
                    <li>Run the simulation and monitor results</li>
                </ol>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('simulations') }}" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start Simulation
                    </a>
                    <button class="btn btn-outline-info" onclick="showQuickNetworkViz()">
                        <i class="fas fa-eye"></i> Quick Network View
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <p><i class="fas fa-check-circle text-success"></i> EPANET Toolkit: Ready</p>
                    <p><i class="fas fa-check-circle text-success"></i> Python Environment: Active</p>
                    <p><i class="fas fa-check-circle text-success"></i> Web Server: Running</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> About HydroTwin</h5>
            </div>
            <div class="card-body">
                <p>HydroTwin is a comprehensive web-based platform for real-time EPANET water distribution network simulation. It provides:</p>
                <ul>
                    <li><strong>Real-time Simulation:</strong> Step-by-step hydraulic analysis with configurable time steps</li>
                    <li><strong>Sensor Monitoring:</strong> Virtual sensors for pressure, flow, and tank level monitoring</li>
                    <li><strong>Control Logic:</strong> Automated control systems based on sensor readings</li>
                    <li><strong>SCADA Integration:</strong> Database logging and real-time data integration</li>
                    <li><strong>Performance Tracking:</strong> Comprehensive metrics and reporting</li>
                    <li><strong>Visualization:</strong> Real-time plotting and data visualization</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load network files count
    fetch('/api/network-files')
        .then(response => response.json())
        .then(data => {
            document.getElementById('network-count').textContent = data.files.length + ' Available';
        })
        .catch(error => {
            document.getElementById('network-count').textContent = 'Error loading';
        });
});

function showQuickNetworkViz() {
    // Get the first available network file
    fetch('/api/network-files')
        .then(response => response.json())
        .then(data => {
            if (data.files && data.files.length > 0) {
                const networkFile = data.files[0];
                showNetworkVisualization(networkFile, 'comprehensive');
            } else {
                alert('No network files available');
            }
        })
        .catch(error => {
            alert('Error loading network files: ' + error.message);
        });
}

function showNetworkVisualization(networkFile, vizType = 'comprehensive') {
    // Create modal for network visualization
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Network Visualization - ${networkFile}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="network-viz-loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Loading network visualization...</p>
                    </div>
                    <div id="network-viz-content" style="display: none;">
                        <img id="network-viz-image" class="img-fluid" alt="Network Visualization" style="max-width: 100%; height: auto;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadNetworkViz('${networkFile}', '${vizType}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Load visualization
    fetch(`/api/network-visualization/${networkFile}?type=${vizType}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('network-viz-loading').innerHTML = 
                    `<p class="text-danger">Error: ${data.error}</p>`;
            } else {
                document.getElementById('network-viz-loading').style.display = 'none';
                document.getElementById('network-viz-content').style.display = 'block';
                const img = document.getElementById('network-viz-image');
                img.src = `data:image/png;base64,${data.image}`;
                img.onload = function() {
                    console.log('Network visualization image loaded successfully');
                };
                img.onerror = function() {
                    console.error('Failed to load network visualization image');
                    document.getElementById('network-viz-content').innerHTML = 
                        `<p class="text-danger">Failed to load image</p>`;
                };
            }
        })
        .catch(error => {
            document.getElementById('network-viz-loading').innerHTML = 
                `<p class="text-danger">Error loading visualization: ${error.message}</p>`;
        });
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function downloadNetworkViz(networkFile, vizType) {
    fetch(`/api/network-visualization-save/${networkFile}?type=${vizType}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.href = data.download_url;
                downloadLink.download = data.filename;
                downloadLink.click();
            }
        })
        .catch(error => {
            alert('Error saving visualization: ' + error.message);
        });
}
</script>
{% endblock %}
